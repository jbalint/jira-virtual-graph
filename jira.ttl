# Jira virtual graph for Stardog
# stardog namespace add bs --prefix jira --uri 'http://github.com/jbalint/jira-virtual-graph#'
# stardog-admin virtual add --overwrite jira.properties jira.ttl
# stardog-admin virtual remove jira
# stardog query execute -r bs "select * { GRAPH <virtual://jira> { ?x a jira:Issue } }"

@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix jira: <http://github.com/jbalint/jira-virtual-graph#> .
@prefix sm: <tag:stardog:api:mapping:> .

jira:IssueType{"id"} a jira:IssueType ;
  jira:name "{\"pname\"}" ;
  jira:description "{\"description\"}" ;
  sm:map [
    sm:table "issuetype" ;
  ]
.

jira:Status{"id"} a jira:Status ;
  jira:name "{\"pname\"}" ;
  jira:description "{\"description\"}" ;
  sm:map [
    sm:table "issuestatus" ;
  ]
.
jira:Status{"id"} a jira:OpenStatus ;
  jira:name "{\"pname\"}" ;
  jira:description "{\"description\"}" ;
  sm:map [
    sm:query "select * from issuestatus where id in (3, 10000, 10100, 10200)" ;
  ]
.
jira:Status{"id"} a jira:ClosedStatus ;
  jira:name "{\"pname\"}" ;
  jira:description "{\"description\"}" ;
  sm:map [
    sm:query "select * from issuestatus where id in (5, 10001)" ;
  ]
.

jira:Priority{"id"} a jira:Priority ;
  jira:name "{\"pname\"}" ;
  jira:description "{\"description\"}" ;
  sm:map [
    sm:table "priority" ;
  ]
.

jira:Resolution{"id"} a jira:Resolution ;
  jira:name "{\"pname\"}" ;
  jira:description "{\"description\"}" ;
  sm:map [
    sm:table "resolution" ;
  ]
.

jira:Issue{"id"} a jira:Issue ;
  jira:id "{id}"^^xsd:integer ;
  jira:summary "{summary}" ;
  jira:description "{description}" ;
  jira:status jira:Status{"issuestatus"} ;
  jira:issueType jira:IssueType{"issuetype"} ;
  jira:priority jira:Priority{"priority"} ;
  jira:created "{created}"^^xsd:dateTime ;
  jira:dueDate "{duedate}"^^xsd:date ;
  jira:updated "{updated}"^^xsd:dateTime ;
  jira:resolutionDate "{resolutiondate}"^^xsd:dateTime ;
  jira:resolution jira:Resolution{"resolution"} ;
  jira:issueKey "{p.pkey}-{issuenum}" ;
  jira:project jira:Project{"project"} ;
  jira:estimatedTimeSecs "{timeoriginalestimate}"^^xsd:integer ;
  jira:remainingTimeSecs "{timeestimate}"^^xsd:integer ;
  jira:loggedTimeSecs "{timespent}"^^xsd:integer ;
  sm:map [
    sm:query """
    select i.id,
           i.summary, i.description, i.issuestatus, i.issuetype,
           i.priority, i.created, i.duedate, i.updated, i.resolutiondate, i.resolution,
           i.project, i.issuenum, p.pkey
    from jiraissue i
    inner join project p
    on i.project = p.id
    """ ;
  ]
.

jira:LinkType{"id"} a jira:LinkType ;
  jira:linkName "{\"linkname\"}" ;
  jira:inwardName "{\"inward\"}" ;
  jira:outwardName "{\"outward\"}" ;
  sm:map [
    sm:table "issuelinktype"
  ]
.

jira:IssueLink{"id"} a jira:IssueLink ;
  jira:linkType jira:LinkType{"linktype"} ;
  jira:linkSource jira:Issue{"source"} ;
  jira:linkDestination jira:Issue{"destination"} ;
  sm:map [
    sm:table "issuelink"
  ]
.

jira:RemoteLink{"id"} a jira:RemoteLink ;
  jira:issue jira:Issue{"issueid"} ;
# TODO, this should become an IRI, not a string
  jira:remoteUrl "{\"url\"}" ;
  jira:title "{\"title\"}" ;
  jira:summary "{\"summary\"}" ;
  jira:iconUrl "{\"url\"}" ;
  sm:map [
    sm:table "remotelink" ;
  ]
.

jira:Comment{"id"} a jira:Comment ;
  jira:commentIssue jira:Issue{"issueid"} ;
  jira:commentBody "{\"actionbody\"}" ;
  jira:commentCreateDate "{\"created\"}"^^xsd:dateTime ;
  jira:commentUpdateDate "{\"updated\"}"^^xsd:dateTime ;
  sm:map [
    sm:table "jiraaction"
  ]
.

jira:Project{"id"} a jira:Project ;
  jira:name "{\"pname\"}" ;
  jira:description "{\"description\"}" ;
  jira:projectKey "{\"originalkey\"}" ;
  jira:url <{"url"}> ;
  sm:map [
    sm:table "project"
  ]
.

# jira:Sprint{"id"} a jira:Sprint ;
#   jira:name "{\"name\"}" ;
#   sm:map [
# # TODO need to fix these to be ISO-8601, what about timezone? (guess I'll have to keep it as local time)
#     sm:query """
#     select id,
#            name,
#            started,
#            closed,
#            from_unixtime(complete_date/1000) as complete_date,
#            from_unixtime(end_date/1000) as end_date,
#            from_unixtime(start_date/1000) as start_date,
#            rapid_view_id
#     from AO_60DB71_SPRINT
#     """ ;
#   ]
# .

# TODO: worklog, attachment
